<!doctype html>
<html lang="en">

<head>
  <title>Hello, world!</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
    crossorigin="anonymous">


  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>

  <!--Lodash -->
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js" integrity="sha256-7/yoZS3548fXSRXqc/xYzjsmuW3sFKzuvOCHd06Pmps="
    crossorigin="anonymous"></script>
</head>

<body>
  <br>
  <div class="container">
    <!-- 
      http://www.tesouro.gov.br/-/tesouro-direto-indicadores 
      http://www.b3.com.br/pt_br/
    -->
    <br />
    <h2>Valor e investir mensalmente e por quantos meses</h2>
    <div class="form-row">
      <div class="form-group col-md-12">
        <label>Quantia</label>
        <input type="text" class="form-control" id="quantia" oninput="realizaProjecao()">
      </div>
    </div>
    <hr />
    <h2>Taxas em valores ao ano (%a.a)</h2>
    <div class="form-row">
      <div class="form-group col-md-6">
        <label>IPCA</label>
        <input type="number" value="2.85" class="form-control" id="ipca" oninput="realizaProjecao()">
      </div>
      <div class="form-group col-md-6">
        <label>IGPM</label>
        <input type="number" value="6.68" class="form-control" id="igpm" oninput="realizaProjecao()">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-6">
        <label>Poupança</label>
        <input type="number" value="3.4655" class="form-control" id="poupança" oninput="realizaProjecao()">
      </div>
      <div class="form-group col-md-6">
        <label>SELIC</label>
        <input type="number" value="6.5" class="form-control" id="selic" oninput="realizaProjecao()">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-6">
        <label>DI</label>
        <input type="number" value="6.39" class="form-control" id="di" oninput="realizaProjecao()">
      </div>
    </div>

    <hr />
    <h2>Tesouro direto</h2>
    <div class="form-row">
      <div class="form-group col-md-6">
        <label>pre-fixado-2021</label>
        <input type="number" value="9.60" class="form-control" id="pre-fixado-2021" oninput="realizaProjecao()">
      </div>
      <div class="form-group col-md-6">
        <label>pre-fixado-2025</label>
        <input type="number" value="11.80" class="form-control" id="pre-fixado-2025" oninput="realizaProjecao()">
      </div>
    </div>


    <br />


    <div class="row">
      <h2>Melhor investimento para cada periodo</h2>
      <table class="table" id="tabela-melhor-investimento">
        <thead>
          <tr>
            <th scope="col">investimento</th>
            <th scope="col">periodo em meses</th>
            <th scope="col">taxa</th>
            <th scope="col">aliquota IR</th>
            <th scope="col">valor Bruto</th>
            <th scope="col">valor imposto de renda</th>
            <th scope="col">valor lucro</th>
          </tr>
        </thead>
        <tbody id="projecao-melhor-investimento">
        </tbody>
      </table>
    </div>
    <br />
    <div class="row">
      <button type="button" class="btn btn-info" onclick="download()">Download</button> <br />
      <hr />
    </div>

    <div class="row">
      <div class="col-md-12">
        <div class="accordion" id="accordionExample">
          <div class="card">
            <div class="card-header" id="headingOne">
              <h5 class="mb-0">
                <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne"
                  aria-expanded="true" aria-controls="collapseOne">
                  Tabela investimentos 6 meses
                </button>
              </h5>
            </div>

            <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
              <div class="card-body">
                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">investimento</th>
                      <th scope="col">periodo em meses</th>
                      <th scope="col">taxa</th>
                      <th scope="col">aliquota IR</th>
                      <th scope="col">valor Bruto</th>
                      <th scope="col">valor imposto de renda</th>
                      <th scope="col">valor lucro</th>
                    </tr>
                  </thead>
                  <tbody id="tabela-projecao-6">
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" id="headingTwo">
              <h5 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo"
                  aria-expanded="false" aria-controls="collapseTwo">
                  Tabela investimentos 12 meses
                </button>
              </h5>
            </div>
            <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
              <div class="card-body">
                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">investimento</th>
                      <th scope="col">periodo em meses</th>
                      <th scope="col">taxa</th>
                      <th scope="col">aliquota IR</th>
                      <th scope="col">valor Bruto</th>
                      <th scope="col">valor imposto de renda</th>
                      <th scope="col">valor lucro</th>
                    </tr>
                  </thead>
                  <tbody id="tabela-projecao-12">
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" id="headingThree">
              <h5 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree"
                  aria-expanded="false" aria-controls="collapseThree">
                  Tabela investimentos 24 meses
                </button>
              </h5>
            </div>
            <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
              <div class="card-body">
                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">investimento</th>
                      <th scope="col">periodo em meses</th>
                      <th scope="col">taxa</th>
                      <th scope="col">aliquota IR</th>
                      <th scope="col">valor Bruto</th>
                      <th scope="col">valor imposto de renda</th>
                      <th scope="col">valor lucro</th>
                    </tr>
                  </thead>
                  <tbody id="tabela-projecao-24">
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" id="headingThree">
              <h5 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseFour"
                  aria-expanded="false" aria-controls="collapseFour">
                  Tabela investimentos 30 meses
                </button>
              </h5>
            </div>
            <div id="collapseFour" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
              <div class="card-body">
                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">investimento</th>
                      <th scope="col">periodo em meses</th>
                      <th scope="col">taxa</th>
                      <th scope="col">aliquota IR</th>
                      <th scope="col">valor Bruto</th>
                      <th scope="col">valor imposto de renda</th>
                      <th scope="col">valor lucro</th>
                    </tr>
                  </thead>
                  <tbody id="tabela-projecao-30">
                  </tbody>
                </table>
              </div>
            </div>
          </div>


          <div class="card">
            <div class="card-header" id="headingThree">
              <h5 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseAllTogether"
                  aria-expanded="false" aria-controls="collapseAllTogether">
                  Todos os periodos juntos ordenados pelo valor liquido ASC
                </button>
              </h5>
            </div>
            <div id="collapseAllTogether" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
              <div class="card-body">
                <table class="table" id="tabela-projecao">
                  <thead>
                    <tr>
                      <th scope="col">investimento</th>
                      <th scope="col">periodo em meses</th>
                      <th scope="col">taxa</th>
                      <th scope="col">aliquota IR</th>
                      <th scope="col">valor Bruto</th>
                      <th scope="col">valor imposto de renda</th>
                      <th scope="col">valor lucro</th>
                    </tr>
                  </thead>
                  <tbody id="projecao">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script>
    function jurosCompostos(valor, taxa, prazoEmAnos) {
      const valorFinal = valor * (1 + taxa) ** prazoEmAnos;
      return valorFinal.toFixed(2);
    }
    function getAliquotaImpostoRenda(meses) {
      if (meses <= 6) {
        return 1 - 0.225
      } else if (meses > 6 && meses <= 12) {
        return 1 - 0.20

      } else if (meses > 12 && meses <= 24) {
        return 1 - 0.175

      } else if (meses >= 24) {
        return 1 - 0.15
      } else {
        throw new Error('Error on getAliquotaImpostoRenda for' + meses)
      }
    }

    function realizaProjecao() {
      const quantia = document.querySelector('#quantia').value;

      const ipca = document.querySelector('#ipca').value;
      const igpm = document.querySelector('#igpm').value;
      const poupanca = document.querySelector('#poupança').value;
      const selic = document.querySelector('#selic').value;
      const di = document.querySelector('#di').value;

      const tesouro2021 = document.querySelector('#pre-fixado-2021').value;
      const tesouro2025 = document.querySelector('#pre-fixado-2025').value;

      //TODO: adicionar validacao

      let projecao = [];

      //limpando projecao anterior
      document.querySelector('#projecao').innerHTML = ""
      document.querySelector('#projecao-melhor-investimento').innerHTML = ""

      var opcoes = [
        {
          indice: "cdb {{taxa}}% do DI",
          max: 130,
          min: 90.5,
          taxa: "({{di}} * ({{taxa}} / 100))",
          ir: true
        },
        {
          indice: "cdb {{taxa}}%",
          max: 15,
          min: 9,
          taxa: "{{taxa}}",
          ir: true
        },
        {
          indice: "lci_lca {{taxa}}% DI",
          max: 98,
          min: 80,
          taxa: "({{di}} * ({{taxa}} / 100))",
          ir: false
        },
        {
          indice: "poupanca",
          max: 0,
          min: 0,
          taxa: poupanca,
          ir: false
        },
        {
          indice: "tesouro selic",
          max: 0,
          min: 0,
          taxa: selic,
          ir: true
        }

      ]

      for (var investimento of opcoes) {
        while (investimento.max >= investimento.min) {
          let irMeses = 6;
          while (irMeses <= 30) {
            if (irMeses != 18) {
              const taxa = eval(investimento.taxa.replace('{{di}}', di).replace('{{taxa}}', investimento.max))
              // console.log(taxa)
              // console.log(investimento.taxa.replace('{{di}}', di).replace('{{taxa}}', investimento.max))
              projecao.push({
                indice: investimento.indice.replace('{{taxa}}', investimento.max),
                prazo: irMeses,
                taxa: parseFloat(taxa).toFixed(3),
                valorBruto: jurosCompostos(quantia, taxa.toFixed(3) / 100, irMeses / 12),
                aliquotaIR: investimento.ir ? (1 - getAliquotaImpostoRenda(irMeses)).toFixed(3) : "0"
              })
            }
            irMeses = irMeses + 6;
          }
          investimento.max = investimento.max - 0.5
        }
      }

      let melhorInvestimento = "";
      let projectionType = 6;
      while (projectionType <= 30) {
        let melhoresInvestimentosDoPeriodo = "";
        if (projectionType != 18) {
          const investimentos = []

          //filtrando investimentos para aquele periodo
          for (const item of projecao) {
            if (item.prazo == projectionType) {
              investimentos.push(item)
            }
          }


          const ordenado = _.sortBy(investimentos, [function (o) {
            return o.valorBruto * (1 - o.aliquotaIR)
          }])

          const item = _.last(ordenado)
          melhorInvestimento += `
                    <tr>
                        <td>${item.indice}</td>
                        <td>${item.prazo} meses</td>
                        <td>${item.taxa}</td>
                        <td>${item.aliquotaIR}</td>
                        <td>${item.valorBruto}</td>
                        <td>${(item.valorBruto * item.aliquotaIR).toFixed(2)}</td>
                        <td>${(item.valorBruto * (1 - item.aliquotaIR)).toFixed(2)}</td>
                    </tr>
                    `

          document.querySelector(`#tabela-projecao-${projectionType}`).innerHTML = "";
          for (const opcao of ordenado) {
            melhoresInvestimentosDoPeriodo += `
                    <tr>
                        <td>${opcao.indice}</td>
                        <td>${opcao.prazo} meses</td>
                        <td>${opcao.taxa}</td>
                        <td>${opcao.aliquotaIR}</td>
                        <td>${opcao.valorBruto}</td>
                        <td>${(opcao.valorBruto * opcao.aliquotaIR).toFixed(2)}</td>
                        <td>${(opcao.valorBruto * (1 - opcao.aliquotaIR)).toFixed(2)}</td>
                    </tr>
                    `
          }
          document.querySelector(`#tabela-projecao-${projectionType}`).innerHTML = melhoresInvestimentosDoPeriodo;

        }
        projectionType = projectionType + 6;
      }
      document.querySelector('#projecao-melhor-investimento').innerHTML = melhorInvestimento;



      //Filling the grid with information

      let html = "";
      const ordenadoPreco = _.sortBy(projecao, [function (o) {
        return o.valorBruto * (1 - o.aliquotaIR)
      }])
      for (const item of ordenadoPreco) {
        html += `
                <tr>
                    <td>${item.indice}</td>
                    <td>${item.prazo} meses</td>
                    <td>${item.taxa}</td>
                    <td>${item.aliquotaIR}</td>
                    <td>${item.valorBruto}</td>
                    <td>${(item.valorBruto * item.aliquotaIR).toFixed(2)}</td>
                    <td>${(item.valorBruto * (1 - item.aliquotaIR)).toFixed(2)}</td>
                </tr>
                `
      }
      document.querySelector('#projecao').innerHTML = html
    }

    function download() {
      var htmltable = document.getElementById('tabela-projecao');
      var html = htmltable.outerHTML;
      window.open('data:application/vnd.ms-excel,' + encodeURIComponent(html));
    }
  </script>
</body>

</html>